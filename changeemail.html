<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>è€ç‹CPMå·¥å…·ç®±</title>
<style>
    body { font-family: Arial, sans-serif; background: url("https://i.postimg.cc/XYj6dDzv/IMG-0133.jpg") no-repeat center center fixed; background-size: cover; margin: 0; padding: 0; color: white; }
    .center-wrapper { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    .container { background: rgba(255, 255, 255, 0.2); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border: 1px solid rgba(255, 255, 255, 0.3); padding: 20px 30px 10px 30px; border-radius: 10px; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); width: 295px; text-align: center; }
    input { width:85%; padding:10px; margin:8px 0; border-radius:5px; border:none; background: rgba(255,255,255,0.1); color:#fff; outline: none; text-align: center; }
    button { width: 99%; padding: 10px; margin: 6px 0; border-radius: 5px; cursor: pointer; background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.4); box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); color: #ffffff; font-weight: bold; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.5); transition: 0.3s; }
    button:hover { background: rgba(255, 255, 255, 0.25); }
    .status { margin-top:10px; color:#0f0; word-wrap: break-word; font-size: 14px; min-height: 20px;}
    .error { color:#f55; }
    #authForm, #loginForm, #menuButtons { display: none; }
    footer { margin-top: 15px; font-size: 13px; color: #fff; opacity: 0.8; }
</style>
</head>
<body>

<div class="center-wrapper">
  <div class="container">
      <h1>ğŸ‘‘è€ç‹å·¥å…·ç®±ğŸ‘‘</h1>
      <div id="authForm">
          <input type="text" id="cdkInput" placeholder="è¯·è¾“å…¥æ¿€æ´»ç " />
          <button onclick="verifyCDK()">æ¿€æ´»å·¥å…·</button>
      </div>
      <div id="loginForm">
          <input type="email" id="email" placeholder="æ¸¸æˆé‚®ç®±" />
          <input type="password" id="password" placeholder="æ¸¸æˆå¯†ç " />
          <button onclick="loginFirebase()">éªŒè¯ç™»å½•</button>
      </div>
      <div id="menuButtons">
          <button onclick="kingRank()">ğŸ‘‘ ä¸€é”®çš‡å† ç­‰çº§</button>
          <button onclick="changeEmail()">ğŸ“§ ä¿®æ”¹é‚®ç®±</button>
          <button onclick="changePassword()">ğŸ” ä¿®æ”¹å¯†ç </button>
          <button style="background:rgba(255,165,0,0.2)" onclick="logout()">ğŸšª å®‰å…¨é€€å‡º</button> 
      </div>
      <div id="status" class="status"></div>
      <footer>Â© CPMè€ç‹ç‰ˆæƒæ‰€æœ‰</footer>
  </div>
</div>

<script>
let currentUser = null;
let currentToken = null;

const FIREBASE_API_KEY = "AIzaSyBW1ZbMiUeDZHYUO2bY8Bfnf5rRgrQGPTM";
const RANK_URL = "https://us-central1-cp-multiplayer.cloudfunctions.net/SetUserRating4";
const KEYS_URL = "https://laowang-auth.zeabur.app/verify";

function updateStatus(message, isError=false) {
    const status = document.getElementById('status');
    status.className = isError ? 'status error' : 'status';
    status.textContent = message;
}

document.addEventListener("DOMContentLoaded", () => {
    const savedVip = localStorage.getItem('laowang_vip');
    const savedKey = localStorage.getItem('laowang_key');

    if (savedKey) {
        document.getElementById('cdkInput').value = savedKey;
    }

    if (savedVip === 'true') {
        showLoginForm();
    } else {
        document.getElementById('authForm').style.display = 'block';
    }
});

async function verifyCDK() {
    const input = document.getElementById('cdkInput').value.trim();
    if (!input) return updateStatus("è¯·è¾“å…¥æ¿€æ´»ç ï¼", true);

    updateStatus("æ­£åœ¨äº‘ç«¯å®‰å…¨éªŒè¯...");

    try {
        const res = await fetch(KEYS_URL, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ key: input })
        }); 

        const result = await res.json();
        
        if (result.success) {
            localStorage.setItem('laowang_vip', 'true'); 
            localStorage.setItem('laowang_key', input);
            
            updateStatus("âœ… æ¿€æ´»æˆåŠŸï¼"); 
            alert("æ¿€æ´»æˆåŠŸï¼\næ‚¨çš„ä¼šå‘˜æœ‰æ•ˆæœŸè‡³ï¼š" + result.expire);
            setTimeout(() => { showLoginForm(); }, 1000);
        } else {
            updateStatus("âŒ " + result.msg, true);
        }
    } catch (e) {
        updateStatus("ğŸŒ è”ç½‘å¤±è´¥ï¼Œè¯·é‡è¯•", true);
    }
}

function showLoginForm() {
    document.getElementById('authForm').style.display = 'none';
    document.getElementById('loginForm').style.display = 'block';
    document.getElementById('menuButtons').style.display = 'none';
}

function logout() {
    currentUser = null;
    currentToken = null;
    location.reload(); 
}

async function loginFirebase() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    if(!email || !password) return updateStatus("é‚®ç®±å¯†ç ä¸èƒ½ä¸ºç©º", true);
    updateStatus("æ­£åœ¨ç™»å½•æ¸¸æˆæœåŠ¡å™¨...");
    try {
        const response = await fetch(`https://www.googleapis.com/identitytoolkit/v3/relyingparty/verifyPassword?key=${FIREBASE_API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, password, returnSecureToken: true })
        });
        const data = await response.json();
        if(data.idToken) {
            currentUser = email;
            currentToken = data.idToken;
            updateStatus(`âœ… æ¬¢è¿, ${email}`);
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('menuButtons').style.display = 'block';
        } else {
            updateStatus("è´¦å·å¯†ç é”™è¯¯: " + (data.error?.message || "æœªçŸ¥"), true);
        }
    } catch(err) { updateStatus("ç™»å½•å¤±è´¥ï¼Œæ£€æŸ¥ç½‘ç»œ", true); }
}

async function kingRank() {
  if(!currentToken) return updateStatus("è¯·å…ˆç™»å½•", true);
  updateStatus(`ğŸ‘‘ æ­£åœ¨è®¾ç½®çš‡å† ...`);
  const ratingData = { "cars": 100000, "car_fix": 100000, "car_collided": 100000, "car_exchange": 100000, "car_trade": 100000, "car_wash": 100000, "slicer_cut": 100000, "drift_max": 100000, "drift": 100000, "cargo": 100000, "delivery": 100000, "taxi": 100000, "levels": 100000, "gifts": 100000, "fuel": 100000, "offroad": 100000, "speed_banner": 100000, "reactions": 100000, "police": 100000, "run": 100000, "real_estate": 100000, "t_distance": 100000, "treasure": 100000, "block_post": 100000, "push_ups": 100000, "burnt_tire": 100000, "passanger_distance": 100000, "time": 10000000000, "race_win": 3000 };
  try {
      const response = await fetch(RANK_URL, {
          method: "POST",
          headers: { "Authorization": `Bearer ${currentToken}`, "Content-Type": "application/json" },
          body: JSON.stringify({ "data": JSON.stringify({ RatingData: ratingData }) })
      });
      if (response.ok) updateStatus(`âœ… çš‡å† ç­‰çº§è®¾ç½®æˆåŠŸï¼`);
      else {
          const err = await response.text();
          updateStatus(`âŒ æ¥å£é”™è¯¯: ${response.status} - ${err.slice(0,100)}`, true);
      }
  } catch (e) { updateStatus(`âŒ è¿è¡Œé”™è¯¯: ${e.message}`, true); }
}

async function changeEmail() {
    if (!currentToken) return updateStatus("ä¼šè¯å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•", true);
    const newEmail = prompt("è¯·è¾“å…¥æ–°é‚®ç®±:");
    if (!newEmail || !newEmail.includes('@')) return updateStatus("é‚®ç®±æ ¼å¼æ— æ•ˆ", true);
    
    updateStatus("æ­£åœ¨ä¿®æ”¹é‚®ç®±...");
    try {
        const response = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:update?key=${FIREBASE_API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idToken: currentToken, email: newEmail, returnSecureToken: true })
        });
        const data = await response.json();
        
        if (data.idToken) {
            currentToken = data.idToken;  // æ›´æ–°ä¸ºæ–° token
            currentUser = data.email;
            updateStatus(`âœ… é‚®ç®±å·²ä¿®æ”¹ä¸º ${data.email}`);
        } else {
            updateStatus("âŒ ä¿®æ”¹å¤±è´¥: " + (data.error?.message || "æœªçŸ¥é”™è¯¯"), true);
        }
    } catch (err) {
        updateStatus("âŒ ç½‘ç»œé”™è¯¯: " + err.message, true);
    }
}

async function changePassword() {
    if (!currentToken) return updateStatus("ä¼šè¯å¤±æ•ˆï¼Œè¯·é‡æ–°ç™»å½•", true);
    const newPassword = prompt("è¯·è¾“å…¥æ–°å¯†ç ï¼ˆå»ºè®®8ä½ä»¥ä¸Šï¼ŒåŒ…å«å­—æ¯æ•°å­—ï¼‰ï¼š");
    if (!newPassword || newPassword.length < 6) return updateStatus("å¯†ç å¤ªçŸ­æˆ–æ— æ•ˆ", true);
    
    updateStatus("æ­£åœ¨ä¿®æ”¹å¯†ç ...");
    try {
        const response = await fetch(`https://identitytoolkit.googleapis.com/v1/accounts:update?key=${FIREBASE_API_KEY}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ idToken: currentToken, password: newPassword, returnSecureToken: true })
        });
        const data = await response.json();
        
        if (data.idToken) {
            currentToken = data.idToken;  // æ›´æ–°ä¸ºæ–° token
            updateStatus(`âœ… å¯†ç ä¿®æ”¹æˆåŠŸ`);
        } else {
            updateStatus("âŒ ä¿®æ”¹å¤±è´¥: " + (data.error?.message || "æœªçŸ¥é”™è¯¯"), true);
        }
    } catch (err) {
        updateStatus("âŒ ç½‘ç»œé”™è¯¯: " + err.message, true);
    }
}
</script>
</body>
</html>